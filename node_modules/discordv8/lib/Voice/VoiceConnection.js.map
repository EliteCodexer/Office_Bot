{"version":3,"sources":["../../src/Voice/VoiceConnection.js"],"names":["MODE_xsalsa20_poly1305","MODE_plain","VoiceConnection","constructor","channel","client","session","token","server","endpoint","id","voiceChannel","split","vWS","ready","vWSData","encoder","udp","playingIntent","playing","streamTime","streamProc","KAI","timestamp","sequence","mode","secret","volume","paused","init","destroy","stopPlaying","clearInterval","internal","sendWS","op","d","guild_id","channel_id","self_mute","self_deaf","voiceConnections","remove","close","e","instream","end","stdin","pause","kill","playStream","stream","channels","self","startTime","Date","now","count","length","retStream","onWarning","send","setTimeout","setSpeaking","emit","buffer","read","newBuffer","Buffer","fill","copy","sendBuffer","nextTime","value","readyState","OPEN","JSON","stringify","speaking","delay","sendPacket","packet","callback","err","port","rawbuffer","opus","Error","sanityCheck","opusBuffer","ssrc","playFile","options","str","undefined","getVolume","Promise","resolve","reject","encodeFile","then","data","proc","intent","catch","error","playRawStream","encodeStream","playArbitraryFFmpeg","ffmpegOptions","Array","encodeArbitraryFFmpeg","lookup","address","family","rejectUnauthorized","udpClient","createSocket","firstPacket","discordIP","discordPort","bind","exclusive","on","msg","rinfo","buffArr","parse","i","indexOf","String","fromCharCode","readUIntLE","toString","modes","Number","server_id","user_id","user","session_id","intervals","misc","setInterval","heartbeat_interval","udpPacket","writeUIntBE","secret_key","ArrayBuffer","Uint8Array","members","get","code","wrapVolume","pipe","setVolume","set","mute","lastVolume","unmute","resume"],"mappings":"AAAA;AACA;;;;;;;;;;;;AAQA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,MAAMA,yBAAyB,mBAA/B;AACA,MAAMC,aAAa,OAAnB;;AAEe,MAAMC,eAAN,0BAA2C;AACzDC,aAAYC,OAAZ,EAAqBC,MAArB,EAA6BC,OAA7B,EAAsCC,KAAtC,EAA6CC,MAA7C,EAAqDC,QAArD,EAA+D;AAC9D;AACA,OAAKC,EAAL,GAAUN,QAAQM,EAAlB;AACA,OAAKC,YAAL,GAAoBP,OAApB;AACA,OAAKC,MAAL,GAAcA,MAAd;AACA,OAAKC,OAAL,GAAeA,OAAf;AACA,OAAKC,KAAL,GAAaA,KAAb;AACA,OAAKC,MAAL,GAAcA,MAAd;AACA,OAAKC,QAAL,GAAgBA,SAASG,KAAT,CAAe,GAAf,EAAoB,CAApB,CAAhB;AACA,OAAKC,GAAL,GAAW,IAAX,CAT8D,CAS7C;AACjB,OAAKC,KAAL,GAAa,KAAb;AACA,OAAKC,OAAL,GAAe,EAAf;AACA,OAAKC,OAAL,GAAe,4BAAf;AACA,OAAKC,GAAL,GAAW,IAAX;AACA,OAAKC,aAAL,GAAqB,IAArB;AACA,OAAKC,OAAL,GAAe,KAAf;AACA,OAAKC,UAAL,GAAkB,CAAlB;AACA,OAAKC,UAAL,GAAkB,IAAlB;AACA,OAAKC,GAAL,GAAW,IAAX;AACA,OAAKC,SAAL,GAAiB,CAAjB;AACA,OAAKC,QAAL,GAAgB,CAAhB;;AAEA,OAAKC,IAAL,GAAY,IAAZ;AACA,OAAKC,MAAL,GAAc,IAAd;;AAEA,OAAKC,MAAL,GAAc,iCAAd;AACA,OAAKC,MAAL,GAAc,KAAd;AACA,OAAKC,IAAL;AACA;;AAEDC,WAAU;AACT,OAAKC,WAAL;AACA,MAAI,KAAKT,GAAT,EAAc;AACbU,iBAAc,KAAKV,GAAnB;AACA;AACD,OAAKjB,MAAL,CAAY4B,QAAZ,CAAqBC,MAArB,CACC;AACCC,OAAK,CADN;AAECC,MAAI;AACHC,cAAW,KAAK7B,MAAL,CAAYE,EADpB;AAEH4B,gBAAa,IAFV;AAGHC,eAAY,IAHT;AAIHC,eAAY;AAJT;AAFL,GADD;AAWA,OAAKnC,MAAL,CAAY4B,QAAZ,CAAqBQ,gBAArB,CAAsCC,MAAtC,CAA6C,IAA7C;AACA,MAAI;AACH,QAAK7B,GAAL,CAAS8B,KAAT;AACA,GAFD,CAEE,OAAMC,CAAN,EAAS,CAAE;AACb,MAAI;AACH,QAAK3B,GAAL,CAAS0B,KAAT;AACA,GAFD,CAEE,OAAMC,CAAN,EAAS,CAAE;AACb;;AAEDb,eAAc;AACb,OAAKZ,OAAL,GAAe,KAAf;AACA,OAAKD,aAAL,GAAqB,IAArB;AACA,MAAI,KAAK2B,QAAT,EAAmB;AAClB;AACA;AACA,yBAAO,KAAKA,QAAZ;AACA,OAAI,KAAKA,QAAL,CAAcC,GAAlB,EAAuB;AACtB,SAAKD,QAAL,CAAcC,GAAd;AACA;AACD,OAAI,KAAKD,QAAL,CAAcf,OAAlB,EAA2B;AAC1B,SAAKe,QAAL,CAAcf,OAAd;AACA;AACD,QAAKe,QAAL,GAAgB,IAAhB;AACA;AACD,MAAI,KAAKxB,UAAT,EAAqB;AACpB,QAAKA,UAAL,CAAgB0B,KAAhB,CAAsBC,KAAtB;AACA,QAAK3B,UAAL,CAAgB4B,IAAhB,CAAqB,SAArB;AACA,QAAK5B,UAAL,GAAkB,IAAlB;AACA;AACD;;AAED6B,YAAWC,MAAX,EAAmBC,WAAS,CAA5B,EAA+B;AAC9B,MAAIC,OAAO,IAAX;AAAA,MACCC,YAAYC,KAAKC,GAAL,EADb;AAAA,MAECC,QAAQ,CAFT;AAAA,MAGCC,SAAS,EAHV;AAAA,MAICC,YAAY,4BAJb;AAAA,MAKCC,YAAY,KALb;;AAOA,OAAKjC,MAAL,GAAcwB,MAAd;AACA,OAAKhC,OAAL,GAAe,IAAf;AACA,OAAKD,aAAL,GAAqByC,SAArB;;AAEA,WAASE,IAAT,GAAgB;AACf,OAAGR,KAAKzB,MAAR,EAAgB;AACf0B,iBAAaC,KAAKC,GAAL,MAAcF,YAAYG,QAAQC,MAAlC,CAAb;AACAI,eAAWD,IAAX,EAAiBH,MAAjB;AACA;AACA;AACD,OAAI,CAACL,KAAKnC,aAAN,IAAuB,CAACmC,KAAKlC,OAAjC,EAA0C;AACzCkC,SAAKU,WAAL,CAAiB,KAAjB;AACAV,SAAKtB,WAAL;AACA4B,cAAUK,IAAV,CAAe,KAAf;AACA;AACA;AACD,OAAI;;AAEH,QAAIC,SAASd,OAAOe,IAAP,CAAY,OAAOd,QAAnB,CAAb;;AAEA,QAAI,CAACa,MAAL,EAAa;AACZ,SAAIL,SAAJ,EAAe;AACdP,WAAKU,WAAL,CAAiB,KAAjB;AACAV,WAAKtB,WAAL;AACA4B,gBAAUK,IAAV,CAAe,KAAf;AACA;AACA,MALD,MAKO;AACNJ,kBAAY,IAAZ;AACAE,iBAAWD,IAAX,EAAiBH,SAAS,EAA1B,EAFM,CAEyB;AAC/B;AACA;AACA;;AAED,QAAIO,OAAOP,MAAP,KAAkB,OAAON,QAA7B,EAAuC;AACvC,SAAIe,YAAY,IAAIC,MAAJ,CAAW,OAAOhB,QAAlB,EAA4BiB,IAA5B,CAAiC,CAAjC,CAAhB;AACAJ,YAAOK,IAAP,CAAYH,SAAZ;AACAF,cAASE,SAAT;AACC;;AAEFV;AACAJ,SAAK7B,QAAL,GAAgB,CAAhB,GAAoB,KAApB,GAA4B6B,KAAK7B,QAAL,IAAiB,CAA7C,GAAiD6B,KAAK7B,QAAL,GAAgB,CAAjE;AACA6B,SAAK9B,SAAL,GAAiB,GAAjB,GAAuB,UAAvB,GAAoC8B,KAAK9B,SAAL,IAAkB,GAAtD,GAA4D8B,KAAK9B,SAAL,GAAiB,CAA7E;;AAEA8B,SAAKkB,UAAL,CAAgBN,MAAhB,EAAwBZ,KAAK7B,QAA7B,EAAuC6B,KAAK9B,SAA5C,EAAwDqB,CAAD,IAAO,CAAG,CAAjE;;AAEA,QAAI4B,WAAWlB,YAAaG,QAAQC,MAApC;;AAEAL,SAAKjC,UAAL,GAAkBqC,QAAQC,MAA1B;;AAEAI,eAAWD,IAAX,EAAiBH,UAAUc,WAAWjB,KAAKC,GAAL,EAArB,CAAjB;;AAEA,QAAI,CAACH,KAAKlC,OAAV,EACCkC,KAAKU,WAAL,CAAiB,IAAjB;;AAEDJ,cAAUK,IAAV,CAAe,MAAf,EAAuBX,KAAKjC,UAA5B;AAEA,IAxCD,CAwCE,OAAOwB,CAAP,EAAU;AACXe,cAAUK,IAAV,CAAe,OAAf,EAAwBpB,CAAxB;AACA;AACD;AACDS,OAAKU,WAAL,CAAiB,IAAjB;AACAF;;AAEA,SAAOF,SAAP;AACA;;AAEDI,aAAYU,KAAZ,EAAmB;AAClB,OAAKtD,OAAL,GAAesD,KAAf;AACA,MAAI,KAAK5D,GAAL,CAAS6D,UAAT,KAAwB,aAAUC,IAAtC,EACC,KAAK9D,GAAL,CAASgD,IAAT,CAAce,KAAKC,SAAL,CAAe;AAC5B1C,OAAI,CADwB;AAE5BC,MAAG;AACF0C,cAAUL,KADR;AAEFM,WAAO;AAFL;AAFyB,GAAf,CAAd;AAOD;;AAEDC,YAAWC,MAAX,EAAmBC,WAAW,UAAUC,GAAV,EAAe,CAAG,CAAhD,EAAkD;AACjD,MAAI9B,OAAO,IAAX;AACAA,OAAKlC,OAAL,GAAe,IAAf;AACA,MAAI;AACH,OAAIkC,KAAKxC,GAAL,CAAS6D,UAAT,KAAwB,aAAUC,IAAtC,EACCtB,KAAKpC,GAAL,CAAS4C,IAAT,CAAcoB,MAAd,EAAsB,CAAtB,EAAyBA,OAAOvB,MAAhC,EAAwCL,KAAKtC,OAAL,CAAaqE,IAArD,EAA2D/B,KAAK5C,QAAhE,EAA0EyE,QAA1E;AACD,GAHD,CAGE,OAAOtC,CAAP,EAAU;AACXS,QAAKlC,OAAL,GAAe,KAAf;AACA+D,YAAStC,CAAT;AACA,UAAO,KAAP;AACA;AACD;;AAED2B,YAAWc,SAAX,EAAsB7D,QAAtB,EAAgCD,SAAhC,EAA2C2D,QAA3C,EAAqD;AACpD,MAAI7B,OAAO,IAAX;AACAA,OAAKlC,OAAL,GAAe,IAAf;AACA,MAAI;AACH,OAAI,CAACkC,KAAKrC,OAAL,CAAasE,IAAlB,EAAuB;AACtBjC,SAAKlC,OAAL,GAAa,KAAb;AACA,UAAM,IAAIoE,KAAJ,CAAU,qDAAV,CAAN;AACA;AACA;;AAED,OAAI,CAAClC,KAAKrC,OAAL,CAAawE,WAAb,EAAL,EAAiC;AAChCnC,SAAKlC,OAAL,GAAe,KAAf;AACA,UAAM,IAAIoE,KAAJ,CAAU,6DAAV,CAAN;AACA;AACA;;AAED,OAAItB,SAASZ,KAAKrC,OAAL,CAAayE,UAAb,CAAwBJ,SAAxB,CAAb;AACA,OAAIJ,SAAS,0BAAgBhB,MAAhB,EAAwBzC,QAAxB,EAAkCD,SAAlC,EAA6C8B,KAAKtC,OAAL,CAAa2E,IAA1D,EAAgErC,KAAK3B,MAArE,CAAb;AACA,UAAO2B,KAAK2B,UAAL,CAAgBC,MAAhB,EAAwBC,QAAxB,CAAP;AAEA,GAjBD,CAiBE,OAAOtC,CAAP,EAAU;AACXS,QAAKlC,OAAL,GAAe,KAAf;AACAkC,QAAKW,IAAL,CAAU,OAAV,EAAmBpB,CAAnB;AACA,UAAO,KAAP;AACA;AACD;;AAED+C,UAASxC,MAAT,EAAiByC,UAAQ,KAAzB,EAAgCV,WAAW,UAAUC,GAAV,EAAeU,GAAf,EAAoB,CAAG,CAAlE,EAAoE;AACnE,MAAIxC,OAAO,IAAX;AACAA,OAAKtB,WAAL;AACA,MAAI,OAAO6D,OAAP,KAAmB,UAAvB,EAAmC;AAClC;AACAV,cAAWU,OAAX;AACA;AACD,MAAI,OAAOA,OAAP,KAAmB,QAAvB,EAAiC;AAChCA,aAAU,EAAV;AACA;AACDA,UAAQjE,MAAR,GAAiBiE,QAAQjE,MAAR,KAAmBmE,SAAnB,GAA+BF,QAAQjE,MAAvC,GAAgD,KAAKoE,SAAL,EAAjE;AACA,SAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,QAAKlF,OAAL,CACEmF,UADF,CACahD,MADb,EACqByC,OADrB,EAEEQ,IAFF,CAEOC,QAAQ;AACbhD,SAAKhC,UAAL,GAAkBgF,KAAKC,IAAvB;AACA,QAAIC,SAASlD,KAAKH,UAAL,CAAgBmD,KAAKlD,MAArB,EAA6B,CAA7B,CAAb;AACA8C,YAAQM,MAAR;AACArB,aAAS,IAAT,EAAeqB,MAAf;AAEA,IARF,EASEC,KATF,CASQC,KATR;AAUA,YAASA,KAAT,CAAe7D,IAAI,IAAnB,EAAyB;AACxBsD,WAAOtD,CAAP;AACAsC,aAAStC,CAAT;AACA;AACD,GAfM,CAAP;AAgBA;;AAED8D,eAAcvD,MAAd,EAAsByC,UAAQ,KAA9B,EAAqCV,WAAW,UAAUC,GAAV,EAAeU,GAAf,EAAoB,CAAG,CAAvE,EAAyE;AACxE,MAAIxC,OAAO,IAAX;AACAA,OAAKtB,WAAL;AACA,MAAI,OAAO6D,OAAP,KAAmB,UAAvB,EAAmC;AAClC;AACAV,cAAWU,OAAX;AACA;AACD,MAAI,OAAOA,OAAP,KAAmB,QAAvB,EAAiC;AAChCA,aAAU,EAAV;AACA;AACDA,UAAQjE,MAAR,GAAiBiE,QAAQjE,MAAR,KAAmBmE,SAAnB,GAA+BF,QAAQjE,MAAvC,GAAgD,KAAKoE,SAAL,EAAjE;AACA,SAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,QAAKlF,OAAL,CACE2F,YADF,CACexD,MADf,EACuByC,OADvB,EAEEQ,IAFF,CAEOC,QAAQ;AACbhD,SAAKhC,UAAL,GAAkBgF,KAAKC,IAAvB;AACAjD,SAAKR,QAAL,GAAgBwD,KAAKxD,QAArB;AACA,QAAI0D,SAASlD,KAAKH,UAAL,CAAgBmD,KAAKlD,MAArB,CAAb;AACA8C,YAAQM,MAAR;AACArB,aAAS,IAAT,EAAeqB,MAAf;AACA,IARF,EASEC,KATF,CASQC,KATR;AAUA,YAASA,KAAT,CAAe7D,IAAI,IAAnB,EAAyB;AACxBsD,WAAOtD,CAAP;AACAsC,aAAStC,CAAT;AACA;AACD,GAfM,CAAP;AAgBA;;AAEDgE,qBAAoBC,aAApB,EAAmCjB,OAAnC,EAA4CV,WAAW,UAAUC,GAAV,EAAeU,GAAf,EAAoB,CAAG,CAA9E,EAAgF;AAC/E,MAAIxC,OAAO,IAAX;AACAA,OAAKtB,WAAL;AACA,MAAI,CAAC8E,aAAD,YAA0BC,KAA9B,EAAqC;AACpCD,mBAAgB,EAAhB;AACA;AACD,MAAI,OAAOjB,OAAP,KAAmB,UAAvB,EAAmC;AAClC;AACAV,cAAWU,OAAX;AACA;AACD,MAAI,OAAOA,OAAP,KAAmB,QAAvB,EAAiC;AAChCA,aAAU,EAAV;AACA;AACDA,UAAQjE,MAAR,GAAiBiE,QAAQjE,MAAR,KAAmBmE,SAAnB,GAA+BF,QAAQjE,MAAvC,GAAgD,KAAKoE,SAAL,EAAjE;AACA,SAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,QAAKlF,OAAL,CACE+F,qBADF,CACwBF,aADxB,EACuCjB,OADvC,EAEEQ,IAFF,CAEOC,QAAQ;AACbhD,SAAKhC,UAAL,GAAkBgF,KAAKC,IAAvB;AACAjD,SAAKR,QAAL,GAAgBwD,KAAKxD,QAArB;AACA,QAAI0D,SAASlD,KAAKH,UAAL,CAAgBmD,KAAKlD,MAArB,CAAb;AACA8C,YAAQM,MAAR;AACArB,aAAS,IAAT,EAAeqB,MAAf;AACA,IARF,EASEC,KATF,CASQC,KATR;AAUA,YAASA,KAAT,CAAe7D,IAAI,IAAnB,EAAyB;AACxBsD,WAAOtD,CAAP;AACAsC,aAAStC,CAAT;AACA;AACD,GAfM,CAAP;AAgBA;;AAEDf,QAAO;AACN,MAAIwB,OAAO,IAAX;AACA,gBAAI2D,MAAJ,CAAW,KAAKvG,QAAhB,EAA0B,CAAC0E,GAAD,EAAM8B,OAAN,EAAeC,MAAf,KAA0B;AACnD,OAAIrG,MAAMwC,KAAKxC,GAAL,GAAW,iBAAc,WAAW,KAAKJ,QAA9B,EAAwC,IAAxC,EAA8C,EAAE0G,oBAAoB,KAAtB,EAA9C,CAArB;AACA,QAAK1G,QAAL,GAAgBwG,OAAhB;AACA,OAAIG,YAAY/D,KAAKpC,GAAL,GAAW,gBAAIoG,YAAJ,CAAiB,MAAjB,CAA3B;;AAEA,OAAIC,cAAc,IAAlB;;AAEA,OAAIC,YAAY,EAAhB;AAAA,OAAoBC,cAAc,EAAlC;;AAEAJ,aAAUK,IAAV,CAAe,EAAEC,WAAW,IAAb,EAAf;AACAN,aAAUO,EAAV,CAAa,SAAb,EAAwB,UAAUC,GAAV,EAAeC,KAAf,EAAsB;AAC7C,QAAIC,UAAUlD,KAAKmD,KAAL,CAAWnD,KAAKC,SAAL,CAAe+C,GAAf,CAAX,EAAgCvB,IAA9C;AACA,QAAIiB,gBAAgB,IAApB,EAA0B;AACzB,UAAK,IAAIU,IAAI,CAAb,EAAgBA,IAAIF,QAAQG,OAAR,CAAgB,CAAhB,EAAmBD,CAAnB,CAApB,EAA2CA,GAA3C,EAAgD;AAC/CT,mBAAaW,OAAOC,YAAP,CAAoBL,QAAQE,CAAR,CAApB,CAAb;AACA;AACDR,mBAAcI,IAAIQ,UAAJ,CAAeR,IAAIlE,MAAJ,GAAa,CAA5B,EAA+B,CAA/B,EAAkC2E,QAAlC,CAA2C,EAA3C,CAAd;;AAEA,SAAIC,QAAQjF,KAAKtC,OAAL,CAAauH,KAAzB;AACA,SAAI7G,OAAOzB,sBAAX;AACA,SAAIsI,MAAML,OAAN,CAAcjI,sBAAd,IAAwC,CAA5C,EAA+C;AAC9CyB,aAAOxB,UAAP;AACAoD,WAAKhD,MAAL,CAAY2D,IAAZ,CAAiB,OAAjB,EAA0B,uEAA1B;AACA;;AAEDnD,SAAIgD,IAAJ,CAASe,KAAKC,SAAL,CAAe;AACvB,YAAM,CADiB;AAEvB,WAAK;AACJ,mBAAY,KADR;AAEJ,eAAQ;AACP,mBAAW0C,SADJ;AAEP,gBAAQgB,OAAOf,WAAP,CAFD;AAGP,gBAAQ/F;AAHD;AAFJ;AAFkB,MAAf,CAAT;AAWA6F,mBAAc,KAAd;AACA;AACD,IA5BD;;AA8BAzG,OAAI8G,EAAJ,CAAO,MAAP,EAAe,MAAM;AACpB9G,QAAIgD,IAAJ,CAASe,KAAKC,SAAL,CAAe;AACvB1C,SAAI,CADmB;AAEvBC,QAAG;AACFoG,iBAAWnF,KAAK7C,MAAL,CAAYE,EADrB;AAEF+H,eAASpF,KAAKhD,MAAL,CAAY4B,QAAZ,CAAqByG,IAArB,CAA0BhI,EAFjC;AAGFiI,kBAAYtF,KAAK/C,OAHf;AAIFC,aAAO8C,KAAK9C;AAJV;AAFoB,KAAf,CAAT;AASA,IAVD;;AAYA,OAAIe,GAAJ;;AAEAT,OAAI8G,EAAJ,CAAO,SAAP,EAAmBC,GAAD,IAAS;AAC1B,QAAIvB,OAAOzB,KAAKmD,KAAL,CAAWH,GAAX,CAAX;AACA,YAAQvB,KAAKlE,EAAb;AACC,UAAK,CAAL;AACCkB,WAAKtC,OAAL,GAAesF,KAAKjE,CAApB;;AAEAiB,WAAK/B,GAAL,GAAWA,MAAM+B,KAAKhD,MAAL,CAAY4B,QAAZ,CAAqB2G,SAArB,CAA+BC,IAA/B,CAAoC,UAApC,IAAkDC,YAAY,MAAM;AACpF,WAAIjI,OAAOA,IAAI6D,UAAJ,KAAmB,aAAUC,IAAxC,EACC9D,IAAIgD,IAAJ,CAASe,KAAKC,SAAL,CAAe;AACvB1C,YAAI,CADmB;AAEvBC,WAAG;AAFoB,QAAf,CAAT;AAID,OANkE,EAMhEiE,KAAKjE,CAAL,CAAO2G,kBANyD,CAAnE;;AAQA,UAAIC,YAAY,IAAI5E,MAAJ,CAAW,EAAX,CAAhB;AACA4E,gBAAUC,WAAV,CAAsB5C,KAAKjE,CAAL,CAAOsD,IAA7B,EAAmC,CAAnC,EAAsC,CAAtC;AACA0B,gBAAUvD,IAAV,CAAemF,SAAf,EAA0B,CAA1B,EAA6BA,UAAUtF,MAAvC,EAA+C2C,KAAKjE,CAAL,CAAOgD,IAAtD,EAA4D/B,KAAK5C,QAAjE,EAA2E0E,OAAO;AACjF,WAAIA,GAAJ,EACC9B,KAAKW,IAAL,CAAU,OAAV,EAAmBmB,GAAnB;AACD,OAHD;AAIA;AACD,UAAK,CAAL;AACC,UAAIkB,KAAKjE,CAAL,CAAO8G,UAAP,IAAqB7C,KAAKjE,CAAL,CAAO8G,UAAP,CAAkBxF,MAAlB,GAA2B,CAApD,EAAuD;AACtD,aAAMO,SAAS,IAAIkF,WAAJ,CAAgB9C,KAAKjE,CAAL,CAAO8G,UAAP,CAAkBxF,MAAlC,CAAf;AACAL,YAAK3B,MAAL,GAAc,IAAI0H,UAAJ,CAAenF,MAAf,CAAd;AACA,YAAK,IAAI+D,IAAI,CAAb,EAAgBA,IAAI,KAAKtG,MAAL,CAAYgC,MAAhC,EAAwCsE,GAAxC,EAA6C;AAC5C3E,aAAK3B,MAAL,CAAYsG,CAAZ,IAAiB3B,KAAKjE,CAAL,CAAO8G,UAAP,CAAkBlB,CAAlB,CAAjB;AACA;AACD;;AAED3E,WAAKvC,KAAL,GAAa,IAAb;AACAuC,WAAK5B,IAAL,GAAY4E,KAAKjE,CAAL,CAAOX,IAAnB;AACA4B,WAAKW,IAAL,CAAU,OAAV,EAAmBX,IAAnB;;AAEA;AACD,UAAK,CAAL;AACC,UAAIqF,OAAOrF,KAAK7C,MAAL,CAAY6I,OAAZ,CAAoBC,GAApB,CAAwB,IAAxB,EAA8BjD,KAAKjE,CAAL,CAAOqG,OAArC,CAAX;;AAEA,UAAIC,IAAJ,EAAS;AACR,WAAI5D,WAAWuB,KAAKjE,CAAL,CAAO0C,QAAtB;AACA,WAAI1E,UAAUsI,KAAK/H,YAAnB;;AAEA,WAAIP,OAAJ,EAAY;AACXsI,aAAK5D,QAAL,GAAgBA,QAAhB;AACAzB,aAAKhD,MAAL,CAAY2D,IAAZ,CAAiB,eAAjB,EAAkC5D,OAAlC,EAA2CsI,IAA3C;AACA,QAHD,MAGO;AACNrF,aAAKhD,MAAL,CAAY2D,IAAZ,CAAiB,MAAjB,EAAyB,4DAAzB;AACA;AACD,OAVD,MAUO;AACNX,YAAKhD,MAAL,CAAY2D,IAAZ,CAAiB,MAAjB,EAAyB,yDAAzB;AACA;;AAED;AAlDF;AAoDA,IAtDD;;AAwDAnD,OAAI8G,EAAJ,CAAO,OAAP,EAAgB,CAACxC,GAAD,EAAMyC,GAAN,KAAc;AAC7BvE,SAAKW,IAAL,CAAU,OAAV,EAAmBmB,GAAnB,EAAwByC,GAAxB;AACA,IAFD;;AAIA/G,OAAI8G,EAAJ,CAAO,OAAP,EAAiB4B,IAAD,IAAU;AACzBlG,SAAKW,IAAL,CAAU,OAAV,EAAmBuF,IAAnB;AACA,IAFD;AAIA,GAtHD;AAuHA;;AAEDC,YAAWrG,MAAX,EAAmB;AAClBA,SAAOsG,IAAP,CAAY,KAAK9H,MAAjB;;AAEA,SAAO,KAAKA,MAAZ;AACA;;AAED+H,WAAU/H,MAAV,EAAkB;AACjB,OAAKA,MAAL,CAAYgI,GAAZ,CAAgBhI,MAAhB;AACA;;AAEDoE,aAAY;AACX,SAAO,KAAKpE,MAAL,CAAY2H,GAAZ,EAAP;AACA;;AAEDM,QAAO;AACN,OAAKC,UAAL,GAAkB,KAAKlI,MAAL,CAAY2H,GAAZ,EAAlB;AACA,OAAKI,SAAL,CAAe,CAAf;AACA;;AAEDI,UAAS;AACR,OAAKJ,SAAL,CAAe,KAAKG,UAApB;AACA,OAAKA,UAAL,GAAkB/D,SAAlB;AACA;;AAED9C,SAAQ;AACP,OAAKpB,MAAL,GAAc,IAAd;AACA,OAAKmC,WAAL,CAAiB,KAAjB;AACA,OAAK7C,aAAL,CAAmB8C,IAAnB,CAAwB,OAAxB;AACA;;AAED+F,UAAS;AACR,OAAKnI,MAAL,GAAc,KAAd;AACA,OAAKmC,WAAL,CAAiB,IAAjB;AACA,OAAK7C,aAAL,CAAmB8C,IAAnB,CAAwB,QAAxB;AACA;AAncwD;kBAArC9D,e","file":"VoiceConnection.js","sourcesContent":["\"use strict\";\n/*\n\tMajor credit to izy521 who is the creator of\n\thttps://github.com/izy521/discord.io,\n\n\twithout his help voice chat in discord.js would not have\n\tbeen possible!\n*/\n\nimport WebSocket from \"ws\";\nimport dns from \"dns\";\nimport udp from \"dgram\";\nimport AudioEncoder from \"./AudioEncoder\";\nimport VoicePacket from \"./VoicePacket\";\nimport VolumeTransformer from \"./VolumeTransformer\";\nimport StreamIntent from \"./StreamIntent\";\nimport EventEmitter from \"events\";\nimport unpipe from \"unpipe\";\n\nconst MODE_xsalsa20_poly1305 = \"xsalsa20_poly1305\";\nconst MODE_plain = \"plain\";\n\nexport default class VoiceConnection extends EventEmitter {\n\tconstructor(channel, client, session, token, server, endpoint) {\n\t\tsuper();\n\t\tthis.id = channel.id;\n\t\tthis.voiceChannel = channel;\n\t\tthis.client = client;\n\t\tthis.session = session;\n\t\tthis.token = token;\n\t\tthis.server = server;\n\t\tthis.endpoint = endpoint.split(\":\")[0];\n\t\tthis.vWS = null; // vWS means voice websocket\n\t\tthis.ready = false;\n\t\tthis.vWSData = {};\n\t\tthis.encoder = new AudioEncoder();\n\t\tthis.udp = null;\n\t\tthis.playingIntent = null;\n\t\tthis.playing = false;\n\t\tthis.streamTime = 0;\n\t\tthis.streamProc = null;\n\t\tthis.KAI = null;\n\t\tthis.timestamp = 0;\n\t\tthis.sequence = 0;\n\n\t\tthis.mode = null;\n\t\tthis.secret = null;\n\n\t\tthis.volume = new VolumeTransformer();\n\t\tthis.paused = false;\n\t\tthis.init();\n\t}\n\n\tdestroy() {\n\t\tthis.stopPlaying();\n\t\tif (this.KAI) {\n\t\t\tclearInterval(this.KAI);\n\t\t}\n\t\tthis.client.internal.sendWS(\n\t\t\t{\n\t\t\t\top : 4,\n\t\t\t\td : {\n\t\t\t\t\tguild_id : this.server.id,\n\t\t\t\t\tchannel_id : null,\n\t\t\t\t\tself_mute : true,\n\t\t\t\t\tself_deaf : false\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t\tthis.client.internal.voiceConnections.remove(this);\n\t\ttry {\n\t\t\tthis.vWS.close();\n\t\t} catch(e) {}\n\t\ttry {\n\t\t\tthis.udp.close();\n\t\t} catch(e) {}\n\t}\n\n\tstopPlaying() {\n\t\tthis.playing = false;\n\t\tthis.playingIntent = null;\n\t\tif (this.instream) {\n\t\t\t//not all streams implement these...\n\t\t\t//and even file stream don't seem to implement them properly...\n\t\t\tunpipe(this.instream);\n\t\t\tif (this.instream.end) {\n\t\t\t\tthis.instream.end();\n\t\t\t}\n\t\t\tif (this.instream.destroy) {\n\t\t\t\tthis.instream.destroy();\n\t\t\t}\n\t\t\tthis.instream = null;\n\t\t}\n\t\tif (this.streamProc) {\n\t\t\tthis.streamProc.stdin.pause();\n\t\t\tthis.streamProc.kill(\"SIGKILL\");\n\t\t\tthis.streamProc = null;\n\t\t}\n\t}\n\n\tplayStream(stream, channels=2) {\n\t\tvar self = this,\n\t\t\tstartTime = Date.now(),\n\t\t\tcount = 0,\n\t\t\tlength = 20,\n\t\t\tretStream = new StreamIntent(),\n\t\t\tonWarning = false;\n\n\t\tthis.volume = stream;\n\t\tthis.playing = true;\n\t\tthis.playingIntent = retStream;\n\n\t\tfunction send() {\n\t\t\tif(self.paused) {\n\t\t\t\tstartTime += Date.now() - (startTime + count * length);\n\t\t\t\tsetTimeout(send, length);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!self.playingIntent || !self.playing) {\n\t\t\t\tself.setSpeaking(false);\n\t\t\t\tself.stopPlaying();\n\t\t\t\tretStream.emit(\"end\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\ttry {\n\n\t\t\t\tvar buffer = stream.read(1920 * channels);\n\n\t\t\t\tif (!buffer) {\n\t\t\t\t\tif (onWarning) {\n\t\t\t\t\t\tself.setSpeaking(false);\n\t\t\t\t\t\tself.stopPlaying();\n\t\t\t\t\t\tretStream.emit(\"end\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonWarning = true;\n\t\t\t\t\t\tsetTimeout(send, length * 10); // give chance for some data in 200ms to appear\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t }\n\n\t\t\t\t if (buffer.length !== 1920 * channels) {\n\t\t\t\t\tvar newBuffer = new Buffer(1920 * channels).fill(0);\n\t\t\t\t\tbuffer.copy(newBuffer);\n\t\t\t\t\tbuffer = newBuffer;\n\t\t\t\t }\n\n\t\t\t\tcount++;\n\t\t\t\tself.sequence + 1 < 65535 ? self.sequence += 1 : self.sequence = 0;\n\t\t\t\tself.timestamp + 960 < 4294967295 ? self.timestamp += 960 : self.timestamp = 0;\n\n\t\t\t\tself.sendBuffer(buffer, self.sequence, self.timestamp, (e) => { });\n\n\t\t\t\tvar nextTime = startTime + (count * length);\n\n\t\t\t\tself.streamTime = count * length;\n\n\t\t\t\tsetTimeout(send, length + (nextTime - Date.now()));\n\n\t\t\t\tif (!self.playing)\n\t\t\t\t\tself.setSpeaking(true);\n\n\t\t\t\tretStream.emit(\"time\", self.streamTime);\n\n\t\t\t} catch (e) {\n\t\t\t\tretStream.emit(\"error\", e);\n\t\t\t}\n\t\t}\n\t\tself.setSpeaking(true);\n\t\tsend();\n\n\t\treturn retStream;\n\t}\n\n\tsetSpeaking(value) {\n\t\tthis.playing = value;\n\t\tif (this.vWS.readyState === WebSocket.OPEN)\n\t\t\tthis.vWS.send(JSON.stringify({\n\t\t\t\top: 5,\n\t\t\t\td: {\n\t\t\t\t\tspeaking: value,\n\t\t\t\t\tdelay: 0\n\t\t\t\t}\n\t\t\t}));\n\t}\n\n\tsendPacket(packet, callback = function (err) { }) {\n\t\tvar self = this;\n\t\tself.playing = true;\n\t\ttry {\n\t\t\tif (self.vWS.readyState === WebSocket.OPEN)\n\t\t\t\tself.udp.send(packet, 0, packet.length, self.vWSData.port, self.endpoint, callback);\n\t\t} catch (e) {\n\t\t\tself.playing = false;\n\t\t\tcallback(e);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tsendBuffer(rawbuffer, sequence, timestamp, callback) {\n\t\tvar self = this;\n\t\tself.playing = true;\n\t\ttry {\n\t\t\tif (!self.encoder.opus){\n\t\t\t\tself.playing=false;\n\t\t\t\tthrow new Error(\"node-opus not found! Perhaps you didn't install it.\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!self.encoder.sanityCheck()) {\n\t\t\t\tself.playing = false;\n\t\t\t\tthrow new Error(\"node-opus sanity check failed! Try re-installing node-opus.\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar buffer = self.encoder.opusBuffer(rawbuffer);\n\t\t\tvar packet = new VoicePacket(buffer, sequence, timestamp, self.vWSData.ssrc, self.secret);\n\t\t\treturn self.sendPacket(packet, callback);\n\n\t\t} catch (e) {\n\t\t\tself.playing = false;\n\t\t\tself.emit(\"error\", e);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tplayFile(stream, options=false, callback = function (err, str) { }) {\n\t\tvar self = this;\n\t\tself.stopPlaying();\n\t\tif (typeof options === \"function\") {\n\t\t\t// options is the callback\n\t\t\tcallback = options;\n\t\t}\n\t\tif (typeof options !== \"object\") {\n\t\t\toptions = {};\n\t\t}\n\t\toptions.volume = options.volume !== undefined ? options.volume : this.getVolume();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.encoder\n\t\t\t\t.encodeFile(stream, options)\n\t\t\t\t.then(data => {\n\t\t\t\t\tself.streamProc = data.proc;\n\t\t\t\t\tvar intent = self.playStream(data.stream, 2);\n\t\t\t\t\tresolve(intent);\n\t\t\t\t\tcallback(null, intent);\n\n\t\t\t\t})\n\t\t\t\t.catch(error);\n\t\t\tfunction error(e = true) {\n\t\t\t\treject(e);\n\t\t\t\tcallback(e);\n\t\t\t}\n\t\t})\n\t}\n\n\tplayRawStream(stream, options=false, callback = function (err, str) { }) {\n\t\tvar self = this;\n\t\tself.stopPlaying();\n\t\tif (typeof options === \"function\") {\n\t\t\t// options is the callback\n\t\t\tcallback = options;\n\t\t}\n\t\tif (typeof options !== \"object\") {\n\t\t\toptions = {};\n\t\t}\n\t\toptions.volume = options.volume !== undefined ? options.volume : this.getVolume();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.encoder\n\t\t\t\t.encodeStream(stream, options)\n\t\t\t\t.then(data => {\n\t\t\t\t\tself.streamProc = data.proc;\n\t\t\t\t\tself.instream = data.instream;\n\t\t\t\t\tvar intent = self.playStream(data.stream);\n\t\t\t\t\tresolve(intent);\n\t\t\t\t\tcallback(null, intent);\n\t\t\t\t})\n\t\t\t\t.catch(error);\n\t\t\tfunction error(e = true) {\n\t\t\t\treject(e);\n\t\t\t\tcallback(e);\n\t\t\t}\n\t\t})\n\t}\n\n\tplayArbitraryFFmpeg(ffmpegOptions, options, callback = function (err, str) { }) {\n\t\tvar self = this;\n\t\tself.stopPlaying();\n\t\tif (!ffmpegOptions instanceof Array) {\n\t\t\tffmpegOptions = [];\n\t\t}\n\t\tif (typeof options === \"function\") {\n\t\t\t// options is the callback\n\t\t\tcallback = options;\n\t\t}\n\t\tif (typeof options !== \"object\") {\n\t\t\toptions = {};\n\t\t}\n\t\toptions.volume = options.volume !== undefined ? options.volume : this.getVolume();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.encoder\n\t\t\t\t.encodeArbitraryFFmpeg(ffmpegOptions, options)\n\t\t\t\t.then(data => {\n\t\t\t\t\tself.streamProc = data.proc;\n\t\t\t\t\tself.instream = data.instream;\n\t\t\t\t\tvar intent = self.playStream(data.stream);\n\t\t\t\t\tresolve(intent);\n\t\t\t\t\tcallback(null, intent);\n\t\t\t\t})\n\t\t\t\t.catch(error);\n\t\t\tfunction error(e = true) {\n\t\t\t\treject(e);\n\t\t\t\tcallback(e);\n\t\t\t}\n\t\t})\n\t}\n\n\tinit() {\n\t\tvar self = this;\n\t\tdns.lookup(this.endpoint, (err, address, family) => {\n\t\t\tvar vWS = self.vWS = new WebSocket(\"wss://\" + this.endpoint, null, { rejectUnauthorized: false });\n\t\t\tthis.endpoint = address;\n\t\t\tvar udpClient = self.udp = udp.createSocket(\"udp4\");\n\n\t\t\tvar firstPacket = true;\n\n\t\t\tvar discordIP = \"\", discordPort = \"\";\n\n\t\t\tudpClient.bind({ exclusive: true });\n\t\t\tudpClient.on('message', function (msg, rinfo) {\n\t\t\t\tvar buffArr = JSON.parse(JSON.stringify(msg)).data;\n\t\t\t\tif (firstPacket === true) {\n\t\t\t\t\tfor (var i = 4; i < buffArr.indexOf(0, i); i++) {\n\t\t\t\t\t\tdiscordIP += String.fromCharCode(buffArr[i]);\n\t\t\t\t\t}\n\t\t\t\t\tdiscordPort = msg.readUIntLE(msg.length - 2, 2).toString(10);\n\n\t\t\t\t\tvar modes = self.vWSData.modes;\n\t\t\t\t\tvar mode = MODE_xsalsa20_poly1305;\n\t\t\t\t\tif (modes.indexOf(MODE_xsalsa20_poly1305) < 0) {\n\t\t\t\t\t\tmode = MODE_plain;\n\t\t\t\t\t\tself.client.emit(\"debug\", \"Encrypted mode not reported as supported by the server, using 'plain'\");\n\t\t\t\t\t}\n\n\t\t\t\t\tvWS.send(JSON.stringify({\n\t\t\t\t\t\t\"op\": 1,\n\t\t\t\t\t\t\"d\": {\n\t\t\t\t\t\t\t\"protocol\": \"udp\",\n\t\t\t\t\t\t\t\"data\": {\n\t\t\t\t\t\t\t\t\"address\": discordIP,\n\t\t\t\t\t\t\t\t\"port\": Number(discordPort),\n\t\t\t\t\t\t\t\t\"mode\": mode\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t\tfirstPacket = false;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvWS.on(\"open\", () => {\n\t\t\t\tvWS.send(JSON.stringify({\n\t\t\t\t\top: 0,\n\t\t\t\t\td: {\n\t\t\t\t\t\tserver_id: self.server.id,\n\t\t\t\t\t\tuser_id: self.client.internal.user.id,\n\t\t\t\t\t\tsession_id: self.session,\n\t\t\t\t\t\ttoken: self.token\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t});\n\n\t\t\tvar KAI;\n\n\t\t\tvWS.on(\"message\", (msg) => {\n\t\t\t\tvar data = JSON.parse(msg);\n\t\t\t\tswitch (data.op) {\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\tself.vWSData = data.d;\n\n\t\t\t\t\t\tself.KAI = KAI = self.client.internal.intervals.misc[\"voiceKAI\"] = setInterval(() => {\n\t\t\t\t\t\t\tif (vWS && vWS.readyState === WebSocket.OPEN)\n\t\t\t\t\t\t\t\tvWS.send(JSON.stringify({\n\t\t\t\t\t\t\t\t\top: 3,\n\t\t\t\t\t\t\t\t\td: null\n\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t}, data.d.heartbeat_interval);\n\n\t\t\t\t\t\tvar udpPacket = new Buffer(70);\n\t\t\t\t\t\tudpPacket.writeUIntBE(data.d.ssrc, 0, 4);\n\t\t\t\t\t\tudpClient.send(udpPacket, 0, udpPacket.length, data.d.port, self.endpoint, err => {\n\t\t\t\t\t\t\tif (err)\n\t\t\t\t\t\t\t\tself.emit(\"error\", err)\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 4:\n\t\t\t\t\t\tif (data.d.secret_key && data.d.secret_key.length > 0) {\n\t\t\t\t\t\t\tconst buffer = new ArrayBuffer(data.d.secret_key.length);\n\t\t\t\t\t\t\tself.secret = new Uint8Array(buffer);\n\t\t\t\t\t\t\tfor (let i = 0; i < this.secret.length; i++) {\n\t\t\t\t\t\t\t\tself.secret[i] = data.d.secret_key[i];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tself.ready = true;\n\t\t\t\t\t\tself.mode = data.d.mode;\n\t\t\t\t\t\tself.emit(\"ready\", self);\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 5:\n\t\t\t\t\t\tvar user = self.server.members.get(\"id\", data.d.user_id);\n\n\t\t\t\t\t\tif (user){\n\t\t\t\t\t\t\tvar speaking = data.d.speaking;\n\t\t\t\t\t\t\tvar channel = user.voiceChannel;\n\n\t\t\t\t\t\t\tif (channel){\n\t\t\t\t\t\t\t\tuser.speaking = speaking;\n\t\t\t\t\t\t\t\tself.client.emit(\"voiceSpeaking\", channel, user);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tself.client.emit(\"warn\", \"channel doesn't exist even though SPEAKING expects them to\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tself.client.emit(\"warn\", \"user doesn't exist even though SPEAKING expects them to\");\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvWS.on(\"error\", (err, msg) => {\n\t\t\t\tself.emit(\"error\", err, msg);\n\t\t\t});\n\n\t\t\tvWS.on(\"close\", (code) => {\n\t\t\t\tself.emit(\"close\", code);\n\t\t\t})\n\n\t\t});\n\t}\n\n\twrapVolume(stream) {\n\t\tstream.pipe(this.volume);\n\n\t\treturn this.volume;\n\t}\n\n\tsetVolume(volume) {\n\t\tthis.volume.set(volume);\n\t}\n\n\tgetVolume() {\n\t\treturn this.volume.get();\n\t}\n\n\tmute() {\n\t\tthis.lastVolume = this.volume.get();\n\t\tthis.setVolume(0);\n\t}\n\n\tunmute() {\n\t\tthis.setVolume(this.lastVolume);\n\t\tthis.lastVolume = undefined;\n\t}\n\n\tpause() {\n\t\tthis.paused = true;\n\t\tthis.setSpeaking(false);\n\t\tthis.playingIntent.emit(\"pause\");\n\t}\n\n\tresume() {\n\t\tthis.paused = false;\n\t\tthis.setSpeaking(true);\n\t\tthis.playingIntent.emit(\"resume\");\n\t}\n}\n"]}