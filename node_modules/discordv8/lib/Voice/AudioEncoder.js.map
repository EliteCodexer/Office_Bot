{"version":3,"sources":["../../src/Voice/AudioEncoder.js"],"names":["opus","require","e","AudioEncoder","constructor","OpusEncoder","choice","sanityCheckPassed","undefined","sanityCheck","_opus","encodeZeroes","zeroes","Buffer","fill","encode","readUIntBE","err","opusBuffer","buffer","getCommand","force","choices","p","spawnSync","error","encodeStream","stream","options","Promise","resolve","reject","volume","command","Error","enc","spawn","seek","dest","pipe","stdin","on","destroy","hookEncodingProcess","encodeFile","file","encodeArbitraryFFmpeg","ffmpegOptions","concat","processKilled","killProcess","cause","pause","kill","ffmpegErrors","stdout","stderr","data","toString","trim","once","emit","code","signal","proc","channels","instream"],"mappings":"AAAA;;;;;;AAEA;;;;AASA;;;;;;AAPA,IAAIA,IAAJ;AACA,IAAI;AACHA,QAAOC,QAAQ,WAAR,CAAP;AACA,CAFD,CAEE,OAAOC,CAAP,EAAU;AACX;AACA;;AAIc,MAAMC,YAAN,CAAmB;AACjCC,eAAc;AACb,MAAIJ,IAAJ,EAAU;AACT,QAAKA,IAAL,GAAY,IAAIA,KAAKK,WAAT,CAAqB,KAArB,EAA4B,CAA5B,CAAZ;AACA;AACD,OAAKC,MAAL,GAAc,KAAd;AACA,OAAKC,iBAAL,GAAyBC,SAAzB;AACA;;AAEDC,eAAc;AACb,MAAIC,QAAQ,KAAKV,IAAjB;AACA,MAAIW,eAAe,YAAW;AAC7B,OAAI;AACH,QAAIC,SAAS,IAAIC,MAAJ,CAAW,IAAX,CAAb;AACAD,WAAOE,IAAP,CAAY,CAAZ;AACA,WAAOJ,MAAMK,MAAN,CAAaH,MAAb,EAAqB,IAArB,EAA2BI,UAA3B,CAAsC,CAAtC,EAAyC,CAAzC,CAAP;AACA,IAJD,CAIE,OAAMC,GAAN,EAAW;AACZ,WAAO,KAAP;AACA;AACD,GARD;AASA,MAAG,KAAKV,iBAAL,KAA2BC,SAA9B,EAAyC,KAAKD,iBAAL,GAA0BI,mBAAmB,QAA7C;AACzC,SAAO,KAAKJ,iBAAZ;AACA;;AAEDW,YAAWC,MAAX,EAAmB;;AAElB,SAAO,KAAKnB,IAAL,CAAUe,MAAV,CAAiBI,MAAjB,EAAyB,IAAzB,CAAP;AAEA;;AAEDC,YAAWC,KAAX,EAAkB;AACjB,MAAG,KAAKf,MAAL,IAAee,KAAlB,EACC,OAAOf,MAAP;;AAED,MAAIgB,UAAU,CAAC,QAAD,EAAW,QAAX,CAAd;;AAEA,OAAK,IAAIhB,MAAT,IAAmBgB,OAAnB,EAA4B;AAC3B,OAAIC,IAAI,wBAAKC,SAAL,CAAelB,MAAf,CAAR;AACA,OAAI,CAACiB,EAAEE,KAAP,EAAc;AACb,SAAKnB,MAAL,GAAcA,MAAd;AACA,WAAOA,MAAP;AACA;AACD;;AAED;AACA;;AAEDoB,cAAaC,MAAb,EAAqBC,OAArB,EAA8B;AAC7B,SAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,QAAKC,MAAL,GAAc,gCAAsBJ,QAAQI,MAA9B,CAAd;;AAEA,OAAIC,UAAU,KAAKb,UAAL,EAAd;;AAEA;AACA,OAAI,CAACa,OAAL,EAAc,OAAOF,OAAO,IAAIG,KAAJ,CAAU,0DAAV,CAAP,CAAP;;AAEd,OAAIC,MAAM,wBAAKC,KAAL,CAAWH,OAAX,EAAoB,CAC7B,IAD6B,EACvB,GADuB,EAE7B,IAF6B,EAEvB,OAFuB,EAG7B,KAH6B,EAGtB,OAHsB,EAI7B,KAJ6B,EAIrBL,QAAQS,IAAR,IAAgB,CAJK,EAK7B,KAL6B,EAKtB,CALsB,EAM7B,QAN6B,CAApB,CAAV;;AASA,OAAIC,OAAOX,OAAOY,IAAP,CAAYJ,IAAIK,KAAhB,CAAX;;AAEAF,QAAKG,EAAL,CAAQ,QAAR,EAAkB,MAAMH,KAAKI,OAAL,EAAxB;AACAJ,QAAKG,EAAL,CAAQ,OAAR,EAAiBxB,OAAOqB,KAAKI,OAAL,EAAxB;;AAEA,QAAKC,mBAAL,CAAyBb,OAAzB,EAAkCC,MAAlC,EAA0CI,GAA1C,EAA+CR,MAA/C;AACA,GAvBM,CAAP;AAwBA;;AAEDiB,YAAWC,IAAX,EAAiBjB,OAAjB,EAA0B;AACzB,SAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,QAAKC,MAAL,GAAc,gCAAsBJ,QAAQI,MAA9B,CAAd;;AAEA,OAAIC,UAAU,KAAKb,UAAL,EAAd;;AAEA;AACA,OAAI,CAACa,OAAL,EAAc,OAAOF,OAAO,IAAIG,KAAJ,CAAU,0DAAV,CAAP,CAAP;;AAEd,OAAIC,MAAM,wBAAKC,KAAL,CAAWH,OAAX,EAAoB,CAC7B,IAD6B,EACvBY,IADuB,EAE7B,IAF6B,EAEvB,OAFuB,EAG7B,KAH6B,EAGtB,OAHsB,EAI7B,KAJ6B,EAIrBjB,QAAQS,IAAR,IAAgB,CAJK,EAK7B,KAL6B,EAKtB,CALsB,EAM7B,QAN6B,CAApB,CAAV;;AASA,QAAKM,mBAAL,CAAyBb,OAAzB,EAAkCC,MAAlC,EAA0CI,GAA1C;AACA,GAlBM,CAAP;AAmBA;;AAEDW,uBAAsBC,aAAtB,EAAqCnB,OAArC,EAA8C;AAC7C,SAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,QAAKC,MAAL,GAAc,gCAAsBJ,QAAQI,MAA9B,CAAd;;AAEA,OAAIC,UAAU,KAAKb,UAAL,EAAd;;AAEA;AACA,OAAI,CAACa,OAAL,EAAc,OAAOF,OAAO,IAAIG,KAAJ,CAAU,0DAAV,CAAP,CAAP;;AAEd;AACAa,mBAAgBA,cAAcC,MAAd,CAAqB,CACpC,IADoC,EAC9B,OAD8B,EAEpC,KAFoC,EAE7B,OAF6B,EAGpC,KAHoC,EAG7B,CAH6B,EAIpC,QAJoC,CAArB,CAAhB;AAMA,OAAIb,MAAM,wBAAKC,KAAL,CAAWH,OAAX,EAAoBc,aAApB,CAAV;;AAEA,QAAKJ,mBAAL,CAAyBb,OAAzB,EAAkCC,MAAlC,EAA0CI,GAA1C;AACA,GAlBM,CAAP;AAmBA;;AAEDQ,qBAAoBb,OAApB,EAA6BC,MAA7B,EAAqCI,GAArC,EAA0CR,MAA1C,EAAkD;AACjD,MAAIsB,gBAAgB,KAApB;;AAEA,WAASC,WAAT,CAAqBC,KAArB,EAA4B;AAC3B,OAAIF,aAAJ,EACC;;AAEDd,OAAIK,KAAJ,CAAUY,KAAV;AACAjB,OAAIkB,IAAJ,CAAS,SAAT;;AAEAJ,mBAAgB,IAAhB;;AAEAlB,UAAOoB,KAAP;AACA;;AAED,MAAIG,eAAe,EAAnB;;AAEAnB,MAAIoB,MAAJ,CAAWhB,IAAX,CAAgB,KAAKP,MAArB;;AAEAG,MAAIqB,MAAJ,CAAWf,EAAX,CAAc,MAAd,EAAuBgB,IAAD,IAAU;AAC/BH,mBAAgB,OAAO,IAAIzC,MAAJ,CAAW4C,IAAX,EAAiBC,QAAjB,GAA4BC,IAA5B,EAAvB;AACA,GAFD;;AAIAxB,MAAIoB,MAAJ,CAAWK,IAAX,CAAgB,KAAhB,EAAuB,MAAM;AAC5BV,eAAY,KAAZ;AACA,GAFD;;AAIAf,MAAIoB,MAAJ,CAAWK,IAAX,CAAgB,OAAhB,EAAyB,MAAM;AAC9BzB,OAAIoB,MAAJ,CAAWM,IAAX,CAAgB,KAAhB;AACA,GAFD;;AAIA1B,MAAIyB,IAAJ,CAAS,MAAT,EAAiB,CAACE,IAAD,EAAOC,MAAP,KAAkB;AAClC,OAAID,IAAJ,EAAU;AACT/B,WAAO,IAAIG,KAAJ,CAAU,aAAaoB,YAAvB,CAAP;AACA;AACD,GAJD;;AAMA,OAAKtB,MAAL,CAAY4B,IAAZ,CAAiB,UAAjB,EAA6B,MAAM;AAClC,OAAIH,OAAO;AACVO,UAAM7B,GADI;AAEVR,YAAQ,KAAKK,MAFH;AAGViC,cAAU;AAHA,IAAX;;AAMA,OAAItC,MAAJ,EAAY;AACX8B,SAAKS,QAAL,GAAgBvC,MAAhB;AACA;;AAEDG,WAAQ2B,IAAR;AACA,GAZD;;AAcA,OAAKzB,MAAL,CAAY4B,IAAZ,CAAiB,KAAjB,EAAwB,MAAM;AAC7BV,eAAY,KAAZ;AACA,GAFD;;AAIA,OAAKlB,MAAL,CAAY4B,IAAZ,CAAiB,OAAjB,EAA0B,MAAM;AAC/BV,eAAY,KAAZ;AACA,GAFD;;AAIA,OAAKlB,MAAL,CAAYS,EAAZ,CAAe,KAAf,EAAsB,MAAM;AAC3BS,eAAY,KAAZ;AACA,GAFD;;AAIA,OAAKlB,MAAL,CAAYS,EAAZ,CAAe,OAAf,EAAwB,MAAM;AAC7BS,eAAY,OAAZ;AACA,GAFD;AAGA;AAxLgC;kBAAb/C,Y","file":"AudioEncoder.js","sourcesContent":["\"use strict\";\n\nimport cpoc from \"child_process\";\n\nvar opus;\ntry {\n\topus = require(\"node-opus\");\n} catch (e) {\n\t// no opus!\n}\n\nimport VolumeTransformer from \"./VolumeTransformer\";\n\nexport default class AudioEncoder {\n\tconstructor() {\n\t\tif (opus) {\n\t\t\tthis.opus = new opus.OpusEncoder(48000, 2);\n\t\t}\n\t\tthis.choice = false;\n\t\tthis.sanityCheckPassed = undefined;\n\t}\n\n\tsanityCheck() {\n\t\tvar _opus = this.opus;\n\t\tvar encodeZeroes = function() {\n\t\t\ttry {\n\t\t\t\tvar zeroes = new Buffer(1920);\n\t\t\t\tzeroes.fill(0);\n\t\t\t\treturn _opus.encode(zeroes, 1920).readUIntBE(0, 3);\n\t\t\t} catch(err) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t};\n\t\tif(this.sanityCheckPassed === undefined) this.sanityCheckPassed = (encodeZeroes() === 16056318);\n\t\treturn this.sanityCheckPassed;\n\t}\n\n\topusBuffer(buffer) {\n\n\t\treturn this.opus.encode(buffer, 1920);\n\n\t}\n\n\tgetCommand(force) {\n\t\tif(this.choice && force)\n\t\t\treturn choice;\n\n\t\tvar choices = [\"avconv\", \"ffmpeg\"];\n\n\t\tfor (var choice of choices) {\n\t\t\tvar p = cpoc.spawnSync(choice);\n\t\t\tif (!p.error) {\n\t\t\t\tthis.choice = choice;\n\t\t\t\treturn choice;\n\t\t\t}\n\t\t}\n\n\t\treturn;\n\t}\n\n\tencodeStream(stream, options) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.volume = new VolumeTransformer(options.volume);\n\n\t\t\tvar command = this.getCommand();\n\n\t\t\t// check if avconv or ffmpeg were found.\n\t\t\tif (!command) return reject(new Error('FFMPEG not found. Make sure it is installed and in path.'));\n\n\t\t\tvar enc = cpoc.spawn(command, [\n\t\t\t\t'-i', '-',\n\t\t\t\t'-f', 's16le',\n\t\t\t\t'-ar', '48000',\n\t\t\t\t'-ss', (options.seek || 0),\n\t\t\t\t'-ac', 2,\n\t\t\t\t'pipe:1'\n\t\t\t]);\n\n\t\t\tvar dest = stream.pipe(enc.stdin);\n\n\t\t\tdest.on('unpipe', () => dest.destroy());\n\t\t\tdest.on('error', err => dest.destroy());\n\n\t\t\tthis.hookEncodingProcess(resolve, reject, enc, stream);\n\t\t});\n\t}\n\n\tencodeFile(file, options) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.volume = new VolumeTransformer(options.volume);\n\n\t\t\tvar command = this.getCommand();\n\n\t\t\t// check if avconv or ffmpeg were found.\n\t\t\tif (!command) return reject(new Error('FFMPEG not found. Make sure it is installed and in path.'));\n\n\t\t\tvar enc = cpoc.spawn(command, [\n\t\t\t\t'-i', file,\n\t\t\t\t'-f', 's16le',\n\t\t\t\t'-ar', '48000',\n\t\t\t\t'-ss', (options.seek || 0),\n\t\t\t\t'-ac', 2,\n\t\t\t\t'pipe:1'\n\t\t\t]);\n\n\t\t\tthis.hookEncodingProcess(resolve, reject, enc);\n\t\t});\n\t}\n\n\tencodeArbitraryFFmpeg(ffmpegOptions, options) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.volume = new VolumeTransformer(options.volume);\n\n\t\t\tvar command = this.getCommand();\n\n\t\t\t// check if avconv or ffmpeg were found.\n\t\t\tif (!command) return reject(new Error('FFMPEG not found. Make sure it is installed and in path.'));\n\n\t\t\t// add options discord.js needs\n\t\t\tffmpegOptions = ffmpegOptions.concat([\n\t\t\t\t'-f', 's16le',\n\t\t\t\t'-ar', '48000',\n\t\t\t\t'-ac', 2,\n\t\t\t\t'pipe:1'\n\t\t\t]);\n\t\t\tvar enc = cpoc.spawn(command, ffmpegOptions);\n\n\t\t\tthis.hookEncodingProcess(resolve, reject, enc);\n\t\t});\n\t}\n\n\thookEncodingProcess(resolve, reject, enc, stream) {\n\t\tvar processKilled = false;\n\n\t\tfunction killProcess(cause) {\n\t\t\tif (processKilled)\n\t\t\t\treturn;\n\n\t\t\tenc.stdin.pause();\n\t\t\tenc.kill(\"SIGKILL\");\n\n\t\t\tprocessKilled = true;\n\n\t\t\treject(cause);\n\t\t}\n\n\t\tvar ffmpegErrors = \"\";\n\n\t\tenc.stdout.pipe(this.volume);\n\n\t\tenc.stderr.on(\"data\", (data) => {\n\t\t\tffmpegErrors += \"\\n\" + new Buffer(data).toString().trim();\n\t\t});\n\n\t\tenc.stdout.once(\"end\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t});\n\n\t\tenc.stdout.once(\"error\", () => {\n\t\t\tenc.stdout.emit(\"end\");\n\t\t});\n\n\t\tenc.once(\"exit\", (code, signal) => {\n\t\t\tif (code) {\n\t\t\t\treject(new Error(\"FFMPEG: \" + ffmpegErrors));\n\t\t\t}\n\t\t});\n\n\t\tthis.volume.once(\"readable\", () => {\n\t\t\tvar data = {\n\t\t\t\tproc: enc,\n\t\t\t\tstream: this.volume,\n\t\t\t\tchannels: 2\n\t\t\t};\n\n\t\t\tif (stream) {\n\t\t\t\tdata.instream = stream;\n\t\t\t}\n\n\t\t\tresolve(data);\n\t\t});\n\n\t\tthis.volume.once(\"end\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t});\n\n\t\tthis.volume.once(\"error\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t})\n\n\t\tthis.volume.on(\"end\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t});\n\n\t\tthis.volume.on(\"close\", () => {\n\t\t\tkillProcess(\"close\");\n\t\t});\n\t}\n}\n"]}