{"version":3,"sources":["../../src/Voice/VoiceConnection.js"],"names":["MODE_xsalsa20_poly1305","MODE_plain","VoiceConnection","channel","client","session","token","server","endpoint","id","voiceChannel","split","vWS","ready","vWSData","encoder","udp","playingIntent","playing","streamTime","streamProc","KAI","timestamp","sequence","mode","secret","volume","paused","init","stopPlaying","clearInterval","internal","sendWS","op","d","guild_id","channel_id","self_mute","self_deaf","voiceConnections","remove","close","e","instream","end","destroy","stdin","pause","kill","stream","channels","self","startTime","Date","now","count","length","retStream","onWarning","send","setTimeout","setSpeaking","emit","buffer","read","newBuffer","Buffer","fill","copy","sendBuffer","nextTime","value","readyState","OPEN","JSON","stringify","speaking","delay","packet","callback","err","port","rawbuffer","opus","Error","sanityCheck","opusBuffer","ssrc","sendPacket","options","str","undefined","getVolume","Promise","resolve","reject","encodeFile","then","data","proc","intent","playStream","catch","error","encodeStream","ffmpegOptions","Array","encodeArbitraryFFmpeg","lookup","address","family","rejectUnauthorized","udpClient","createSocket","firstPacket","discordIP","discordPort","bind","exclusive","on","msg","rinfo","buffArr","parse","i","indexOf","String","fromCharCode","readUIntLE","toString","modes","Number","server_id","user_id","user","session_id","intervals","misc","setInterval","heartbeat_interval","udpPacket","writeUIntBE","secret_key","ArrayBuffer","Uint8Array","members","get","code","pipe","set","lastVolume","setVolume"],"mappings":"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","file":"VoiceConnection.js","sourcesContent":["\"use strict\";\n/*\n\tMajor credit to izy521 who is the creator of\n\thttps://github.com/izy521/discord.io,\n\n\twithout his help voice chat in discord.js would not have\n\tbeen possible!\n*/\n\nimport WebSocket from \"ws\";\nimport dns from \"dns\";\nimport udp from \"dgram\";\nimport AudioEncoder from \"./AudioEncoder\";\nimport VoicePacket from \"./VoicePacket\";\nimport VolumeTransformer from \"./VolumeTransformer\";\nimport StreamIntent from \"./StreamIntent\";\nimport EventEmitter from \"events\";\nimport unpipe from \"unpipe\";\n\nconst MODE_xsalsa20_poly1305 = \"xsalsa20_poly1305\";\nconst MODE_plain = \"plain\";\n\nexport default class VoiceConnection extends EventEmitter {\n\tconstructor(channel, client, session, token, server, endpoint) {\n\t\tsuper();\n\t\tthis.id = channel.id;\n\t\tthis.voiceChannel = channel;\n\t\tthis.client = client;\n\t\tthis.session = session;\n\t\tthis.token = token;\n\t\tthis.server = server;\n\t\tthis.endpoint = endpoint.split(\":\")[0];\n\t\tthis.vWS = null; // vWS means voice websocket\n\t\tthis.ready = false;\n\t\tthis.vWSData = {};\n\t\tthis.encoder = new AudioEncoder();\n\t\tthis.udp = null;\n\t\tthis.playingIntent = null;\n\t\tthis.playing = false;\n\t\tthis.streamTime = 0;\n\t\tthis.streamProc = null;\n\t\tthis.KAI = null;\n\t\tthis.timestamp = 0;\n\t\tthis.sequence = 0;\n\n\t\tthis.mode = null;\n\t\tthis.secret = null;\n\n\t\tthis.volume = new VolumeTransformer();\n\t\tthis.paused = false;\n\t\tthis.init();\n\t}\n\n\tdestroy() {\n\t\tthis.stopPlaying();\n\t\tif (this.KAI) {\n\t\t\tclearInterval(this.KAI);\n\t\t}\n\t\tthis.client.internal.sendWS(\n\t\t\t{\n\t\t\t\top : 4,\n\t\t\t\td : {\n\t\t\t\t\tguild_id : this.server.id,\n\t\t\t\t\tchannel_id : null,\n\t\t\t\t\tself_mute : true,\n\t\t\t\t\tself_deaf : false\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t\tthis.client.internal.voiceConnections.remove(this);\n\t\ttry {\n\t\t\tthis.vWS.close();\n\t\t} catch(e) {}\n\t\ttry {\n\t\t\tthis.udp.close();\n\t\t} catch(e) {}\n\t}\n\n\tstopPlaying() {\n\t\tthis.playing = false;\n\t\tthis.playingIntent = null;\n\t\tif (this.instream) {\n\t\t\t//not all streams implement these...\n\t\t\t//and even file stream don't seem to implement them properly...\n\t\t\tunpipe(this.instream);\n\t\t\tif (this.instream.end) {\n\t\t\t\tthis.instream.end();\n\t\t\t}\n\t\t\tif (this.instream.destroy) {\n\t\t\t\tthis.instream.destroy();\n\t\t\t}\n\t\t\tthis.instream = null;\n\t\t}\n\t\tif (this.streamProc) {\n\t\t\tthis.streamProc.stdin.pause();\n\t\t\tthis.streamProc.kill(\"SIGKILL\");\n\t\t\tthis.streamProc = null;\n\t\t}\n\t}\n\n\tplayStream(stream, channels=2) {\n\t\tvar self = this,\n\t\t\tstartTime = Date.now(),\n\t\t\tcount = 0,\n\t\t\tlength = 20,\n\t\t\tretStream = new StreamIntent(),\n\t\t\tonWarning = false;\n\n\t\tthis.volume = stream;\n\t\tthis.playing = true;\n\t\tthis.playingIntent = retStream;\n\n\t\tfunction send() {\n\t\t\tif(self.paused) {\n\t\t\t\tstartTime += Date.now() - (startTime + count * length);\n\t\t\t\tsetTimeout(send, length);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!self.playingIntent || !self.playing) {\n\t\t\t\tself.setSpeaking(false);\n\t\t\t\tself.stopPlaying();\n\t\t\t\tretStream.emit(\"end\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\ttry {\n\n\t\t\t\tvar buffer = stream.read(1920 * channels);\n\n\t\t\t\tif (!buffer) {\n\t\t\t\t\tif (onWarning) {\n\t\t\t\t\t\tself.setSpeaking(false);\n\t\t\t\t\t\tself.stopPlaying();\n\t\t\t\t\t\tretStream.emit(\"end\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonWarning = true;\n\t\t\t\t\t\tsetTimeout(send, length * 10); // give chance for some data in 200ms to appear\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t }\n\n\t\t\t\t if (buffer.length !== 1920 * channels) {\n\t\t\t\t\tvar newBuffer = new Buffer(1920 * channels).fill(0);\n\t\t\t\t\tbuffer.copy(newBuffer);\n\t\t\t\t\tbuffer = newBuffer;\n\t\t\t\t }\n\n\t\t\t\tcount++;\n\t\t\t\tself.sequence + 1 < 65535 ? self.sequence += 1 : self.sequence = 0;\n\t\t\t\tself.timestamp + 960 < 4294967295 ? self.timestamp += 960 : self.timestamp = 0;\n\n\t\t\t\tself.sendBuffer(buffer, self.sequence, self.timestamp, (e) => { });\n\n\t\t\t\tvar nextTime = startTime + (count * length);\n\n\t\t\t\tself.streamTime = count * length;\n\n\t\t\t\tsetTimeout(send, length + (nextTime - Date.now()));\n\n\t\t\t\tif (!self.playing)\n\t\t\t\t\tself.setSpeaking(true);\n\n\t\t\t\tretStream.emit(\"time\", self.streamTime);\n\n\t\t\t} catch (e) {\n\t\t\t\tretStream.emit(\"error\", e);\n\t\t\t}\n\t\t}\n\t\tself.setSpeaking(true);\n\t\tsend();\n\n\t\treturn retStream;\n\t}\n\n\tsetSpeaking(value) {\n\t\tthis.playing = value;\n\t\tif (this.vWS.readyState === WebSocket.OPEN)\n\t\t\tthis.vWS.send(JSON.stringify({\n\t\t\t\top: 5,\n\t\t\t\td: {\n\t\t\t\t\tspeaking: value,\n\t\t\t\t\tdelay: 0\n\t\t\t\t}\n\t\t\t}));\n\t}\n\n\tsendPacket(packet, callback = function (err) { }) {\n\t\tvar self = this;\n\t\tself.playing = true;\n\t\ttry {\n\t\t\tif (self.vWS.readyState === WebSocket.OPEN)\n\t\t\t\tself.udp.send(packet, 0, packet.length, self.vWSData.port, self.endpoint, callback);\n\t\t} catch (e) {\n\t\t\tself.playing = false;\n\t\t\tcallback(e);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tsendBuffer(rawbuffer, sequence, timestamp, callback) {\n\t\tvar self = this;\n\t\tself.playing = true;\n\t\ttry {\n\t\t\tif (!self.encoder.opus){\n\t\t\t\tself.playing=false;\n\t\t\t\tthrow new Error(\"node-opus not found! Perhaps you didn't install it.\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!self.encoder.sanityCheck()) {\n\t\t\t\tself.playing = false;\n\t\t\t\tthrow new Error(\"node-opus sanity check failed! Try re-installing node-opus.\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar buffer = self.encoder.opusBuffer(rawbuffer);\n\t\t\tvar packet = new VoicePacket(buffer, sequence, timestamp, self.vWSData.ssrc, self.secret);\n\t\t\treturn self.sendPacket(packet, callback);\n\n\t\t} catch (e) {\n\t\t\tself.playing = false;\n\t\t\tself.emit(\"error\", e);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tplayFile(stream, options=false, callback = function (err, str) { }) {\n\t\tvar self = this;\n\t\tself.stopPlaying();\n\t\tif (typeof options === \"function\") {\n\t\t\t// options is the callback\n\t\t\tcallback = options;\n\t\t}\n\t\tif (typeof options !== \"object\") {\n\t\t\toptions = {};\n\t\t}\n\t\toptions.volume = options.volume !== undefined ? options.volume : this.getVolume();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.encoder\n\t\t\t\t.encodeFile(stream, options)\n\t\t\t\t.then(data => {\n\t\t\t\t\tself.streamProc = data.proc;\n\t\t\t\t\tvar intent = self.playStream(data.stream, 2);\n\t\t\t\t\tresolve(intent);\n\t\t\t\t\tcallback(null, intent);\n\n\t\t\t\t})\n\t\t\t\t.catch(error);\n\t\t\tfunction error(e = true) {\n\t\t\t\treject(e);\n\t\t\t\tcallback(e);\n\t\t\t}\n\t\t})\n\t}\n\n\tplayRawStream(stream, options=false, callback = function (err, str) { }) {\n\t\tvar self = this;\n\t\tself.stopPlaying();\n\t\tif (typeof options === \"function\") {\n\t\t\t// options is the callback\n\t\t\tcallback = options;\n\t\t}\n\t\tif (typeof options !== \"object\") {\n\t\t\toptions = {};\n\t\t}\n\t\toptions.volume = options.volume !== undefined ? options.volume : this.getVolume();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.encoder\n\t\t\t\t.encodeStream(stream, options)\n\t\t\t\t.then(data => {\n\t\t\t\t\tself.streamProc = data.proc;\n\t\t\t\t\tself.instream = data.instream;\n\t\t\t\t\tvar intent = self.playStream(data.stream);\n\t\t\t\t\tresolve(intent);\n\t\t\t\t\tcallback(null, intent);\n\t\t\t\t})\n\t\t\t\t.catch(error);\n\t\t\tfunction error(e = true) {\n\t\t\t\treject(e);\n\t\t\t\tcallback(e);\n\t\t\t}\n\t\t})\n\t}\n\n\tplayArbitraryFFmpeg(ffmpegOptions, options, callback = function (err, str) { }) {\n\t\tvar self = this;\n\t\tself.stopPlaying();\n\t\tif (!ffmpegOptions instanceof Array) {\n\t\t\tffmpegOptions = [];\n\t\t}\n\t\tif (typeof options === \"function\") {\n\t\t\t// options is the callback\n\t\t\tcallback = options;\n\t\t}\n\t\tif (typeof options !== \"object\") {\n\t\t\toptions = {};\n\t\t}\n\t\toptions.volume = options.volume !== undefined ? options.volume : this.getVolume();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.encoder\n\t\t\t\t.encodeArbitraryFFmpeg(ffmpegOptions, options)\n\t\t\t\t.then(data => {\n\t\t\t\t\tself.streamProc = data.proc;\n\t\t\t\t\tself.instream = data.instream;\n\t\t\t\t\tvar intent = self.playStream(data.stream);\n\t\t\t\t\tresolve(intent);\n\t\t\t\t\tcallback(null, intent);\n\t\t\t\t})\n\t\t\t\t.catch(error);\n\t\t\tfunction error(e = true) {\n\t\t\t\treject(e);\n\t\t\t\tcallback(e);\n\t\t\t}\n\t\t})\n\t}\n\n\tinit() {\n\t\tvar self = this;\n\t\tdns.lookup(this.endpoint, (err, address, family) => {\n\t\t\tvar vWS = self.vWS = new WebSocket(\"wss://\" + this.endpoint, null, { rejectUnauthorized: false });\n\t\t\tthis.endpoint = address;\n\t\t\tvar udpClient = self.udp = udp.createSocket(\"udp4\");\n\n\t\t\tvar firstPacket = true;\n\n\t\t\tvar discordIP = \"\", discordPort = \"\";\n\n\t\t\tudpClient.bind({ exclusive: true });\n\t\t\tudpClient.on('message', function (msg, rinfo) {\n\t\t\t\tvar buffArr = JSON.parse(JSON.stringify(msg)).data;\n\t\t\t\tif (firstPacket === true) {\n\t\t\t\t\tfor (var i = 4; i < buffArr.indexOf(0, i); i++) {\n\t\t\t\t\t\tdiscordIP += String.fromCharCode(buffArr[i]);\n\t\t\t\t\t}\n\t\t\t\t\tdiscordPort = msg.readUIntLE(msg.length - 2, 2).toString(10);\n\n\t\t\t\t\tvar modes = self.vWSData.modes;\n\t\t\t\t\tvar mode = MODE_xsalsa20_poly1305;\n\t\t\t\t\tif (modes.indexOf(MODE_xsalsa20_poly1305) < 0) {\n\t\t\t\t\t\tmode = MODE_plain;\n\t\t\t\t\t\tself.client.emit(\"debug\", \"Encrypted mode not reported as supported by the server, using 'plain'\");\n\t\t\t\t\t}\n\n\t\t\t\t\tvWS.send(JSON.stringify({\n\t\t\t\t\t\t\"op\": 1,\n\t\t\t\t\t\t\"d\": {\n\t\t\t\t\t\t\t\"protocol\": \"udp\",\n\t\t\t\t\t\t\t\"data\": {\n\t\t\t\t\t\t\t\t\"address\": discordIP,\n\t\t\t\t\t\t\t\t\"port\": Number(discordPort),\n\t\t\t\t\t\t\t\t\"mode\": mode\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t\tfirstPacket = false;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvWS.on(\"open\", () => {\n\t\t\t\tvWS.send(JSON.stringify({\n\t\t\t\t\top: 0,\n\t\t\t\t\td: {\n\t\t\t\t\t\tserver_id: self.server.id,\n\t\t\t\t\t\tuser_id: self.client.internal.user.id,\n\t\t\t\t\t\tsession_id: self.session,\n\t\t\t\t\t\ttoken: self.token\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t});\n\n\t\t\tvar KAI;\n\n\t\t\tvWS.on(\"message\", (msg) => {\n\t\t\t\tvar data = JSON.parse(msg);\n\t\t\t\tswitch (data.op) {\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\tself.vWSData = data.d;\n\n\t\t\t\t\t\tself.KAI = KAI = self.client.internal.intervals.misc[\"voiceKAI\"] = setInterval(() => {\n\t\t\t\t\t\t\tif (vWS && vWS.readyState === WebSocket.OPEN)\n\t\t\t\t\t\t\t\tvWS.send(JSON.stringify({\n\t\t\t\t\t\t\t\t\top: 3,\n\t\t\t\t\t\t\t\t\td: null\n\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t}, data.d.heartbeat_interval);\n\n\t\t\t\t\t\tvar udpPacket = new Buffer(70);\n\t\t\t\t\t\tudpPacket.writeUIntBE(data.d.ssrc, 0, 4);\n\t\t\t\t\t\tudpClient.send(udpPacket, 0, udpPacket.length, data.d.port, self.endpoint, err => {\n\t\t\t\t\t\t\tif (err)\n\t\t\t\t\t\t\t\tself.emit(\"error\", err)\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 4:\n\t\t\t\t\t\tif (data.d.secret_key && data.d.secret_key.length > 0) {\n\t\t\t\t\t\t\tconst buffer = new ArrayBuffer(data.d.secret_key.length);\n\t\t\t\t\t\t\tself.secret = new Uint8Array(buffer);\n\t\t\t\t\t\t\tfor (let i = 0; i < this.secret.length; i++) {\n\t\t\t\t\t\t\t\tself.secret[i] = data.d.secret_key[i];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tself.ready = true;\n\t\t\t\t\t\tself.mode = data.d.mode;\n\t\t\t\t\t\tself.emit(\"ready\", self);\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 5:\n\t\t\t\t\t\tvar user = self.server.members.get(\"id\", data.d.user_id);\n\n\t\t\t\t\t\tif (user){\n\t\t\t\t\t\t\tvar speaking = data.d.speaking;\n\t\t\t\t\t\t\tvar channel = user.voiceChannel;\n\n\t\t\t\t\t\t\tif (channel){\n\t\t\t\t\t\t\t\tuser.speaking = speaking;\n\t\t\t\t\t\t\t\tself.client.emit(\"voiceSpeaking\", channel, user);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tself.client.emit(\"warn\", \"channel doesn't exist even though SPEAKING expects them to\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tself.client.emit(\"warn\", \"user doesn't exist even though SPEAKING expects them to\");\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvWS.on(\"error\", (err, msg) => {\n\t\t\t\tself.emit(\"error\", err, msg);\n\t\t\t});\n\n\t\t\tvWS.on(\"close\", (code) => {\n\t\t\t\tself.emit(\"close\", code);\n\t\t\t})\n\n\t\t});\n\t}\n\n\twrapVolume(stream) {\n\t\tstream.pipe(this.volume);\n\n\t\treturn this.volume;\n\t}\n\n\tsetVolume(volume) {\n\t\tthis.volume.set(volume);\n\t}\n\n\tgetVolume() {\n\t\treturn this.volume.get();\n\t}\n\n\tmute() {\n\t\tthis.lastVolume = this.volume.get();\n\t\tthis.setVolume(0);\n\t}\n\n\tunmute() {\n\t\tthis.setVolume(this.lastVolume);\n\t\tthis.lastVolume = undefined;\n\t}\n\n\tpause() {\n\t\tthis.paused = true;\n\t\tthis.setSpeaking(false);\n\t\tthis.playingIntent.emit(\"pause\");\n\t}\n\n\tresume() {\n\t\tthis.paused = false;\n\t\tthis.setSpeaking(true);\n\t\tthis.playingIntent.emit(\"resume\");\n\t}\n}\n"]}