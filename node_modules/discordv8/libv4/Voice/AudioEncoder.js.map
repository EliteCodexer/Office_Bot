{"version":3,"sources":["../../src/Voice/AudioEncoder.js"],"names":["opus","require","e","AudioEncoder","OpusEncoder","choice","sanityCheckPassed","undefined","_opus","encodeZeroes","zeroes","Buffer","fill","encode","readUIntBE","err","buffer","force","choices","p","spawnSync","error","stream","options","Promise","resolve","reject","volume","command","getCommand","Error","enc","spawn","seek","dest","pipe","stdin","on","destroy","hookEncodingProcess","file","ffmpegOptions","concat","processKilled","killProcess","cause","pause","kill","ffmpegErrors","stdout","stderr","data","toString","trim","once","emit","code","signal","proc","channels","instream"],"mappings":"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","file":"AudioEncoder.js","sourcesContent":["\"use strict\";\n\nimport cpoc from \"child_process\";\n\nvar opus;\ntry {\n\topus = require(\"node-opus\");\n} catch (e) {\n\t// no opus!\n}\n\nimport VolumeTransformer from \"./VolumeTransformer\";\n\nexport default class AudioEncoder {\n\tconstructor() {\n\t\tif (opus) {\n\t\t\tthis.opus = new opus.OpusEncoder(48000, 2);\n\t\t}\n\t\tthis.choice = false;\n\t\tthis.sanityCheckPassed = undefined;\n\t}\n\n\tsanityCheck() {\n\t\tvar _opus = this.opus;\n\t\tvar encodeZeroes = function() {\n\t\t\ttry {\n\t\t\t\tvar zeroes = new Buffer(1920);\n\t\t\t\tzeroes.fill(0);\n\t\t\t\treturn _opus.encode(zeroes, 1920).readUIntBE(0, 3);\n\t\t\t} catch(err) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t};\n\t\tif(this.sanityCheckPassed === undefined) this.sanityCheckPassed = (encodeZeroes() === 16056318);\n\t\treturn this.sanityCheckPassed;\n\t}\n\n\topusBuffer(buffer) {\n\n\t\treturn this.opus.encode(buffer, 1920);\n\n\t}\n\n\tgetCommand(force) {\n\t\tif(this.choice && force)\n\t\t\treturn choice;\n\n\t\tvar choices = [\"avconv\", \"ffmpeg\"];\n\n\t\tfor (var choice of choices) {\n\t\t\tvar p = cpoc.spawnSync(choice);\n\t\t\tif (!p.error) {\n\t\t\t\tthis.choice = choice;\n\t\t\t\treturn choice;\n\t\t\t}\n\t\t}\n\n\t\treturn;\n\t}\n\n\tencodeStream(stream, options) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.volume = new VolumeTransformer(options.volume);\n\n\t\t\tvar command = this.getCommand();\n\n\t\t\t// check if avconv or ffmpeg were found.\n\t\t\tif (!command) return reject(new Error('FFMPEG not found. Make sure it is installed and in path.'));\n\n\t\t\tvar enc = cpoc.spawn(command, [\n\t\t\t\t'-i', '-',\n\t\t\t\t'-f', 's16le',\n\t\t\t\t'-ar', '48000',\n\t\t\t\t'-ss', (options.seek || 0),\n\t\t\t\t'-ac', 2,\n\t\t\t\t'pipe:1'\n\t\t\t]);\n\n\t\t\tvar dest = stream.pipe(enc.stdin);\n\n\t\t\tdest.on('unpipe', () => dest.destroy());\n\t\t\tdest.on('error', err => dest.destroy());\n\n\t\t\tthis.hookEncodingProcess(resolve, reject, enc, stream);\n\t\t});\n\t}\n\n\tencodeFile(file, options) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.volume = new VolumeTransformer(options.volume);\n\n\t\t\tvar command = this.getCommand();\n\n\t\t\t// check if avconv or ffmpeg were found.\n\t\t\tif (!command) return reject(new Error('FFMPEG not found. Make sure it is installed and in path.'));\n\n\t\t\tvar enc = cpoc.spawn(command, [\n\t\t\t\t'-i', file,\n\t\t\t\t'-f', 's16le',\n\t\t\t\t'-ar', '48000',\n\t\t\t\t'-ss', (options.seek || 0),\n\t\t\t\t'-ac', 2,\n\t\t\t\t'pipe:1'\n\t\t\t]);\n\n\t\t\tthis.hookEncodingProcess(resolve, reject, enc);\n\t\t});\n\t}\n\n\tencodeArbitraryFFmpeg(ffmpegOptions, options) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.volume = new VolumeTransformer(options.volume);\n\n\t\t\tvar command = this.getCommand();\n\n\t\t\t// check if avconv or ffmpeg were found.\n\t\t\tif (!command) return reject(new Error('FFMPEG not found. Make sure it is installed and in path.'));\n\n\t\t\t// add options discord.js needs\n\t\t\tffmpegOptions = ffmpegOptions.concat([\n\t\t\t\t'-f', 's16le',\n\t\t\t\t'-ar', '48000',\n\t\t\t\t'-ac', 2,\n\t\t\t\t'pipe:1'\n\t\t\t]);\n\t\t\tvar enc = cpoc.spawn(command, ffmpegOptions);\n\n\t\t\tthis.hookEncodingProcess(resolve, reject, enc);\n\t\t});\n\t}\n\n\thookEncodingProcess(resolve, reject, enc, stream) {\n\t\tvar processKilled = false;\n\n\t\tfunction killProcess(cause) {\n\t\t\tif (processKilled)\n\t\t\t\treturn;\n\n\t\t\tenc.stdin.pause();\n\t\t\tenc.kill(\"SIGKILL\");\n\n\t\t\tprocessKilled = true;\n\n\t\t\treject(cause);\n\t\t}\n\n\t\tvar ffmpegErrors = \"\";\n\n\t\tenc.stdout.pipe(this.volume);\n\n\t\tenc.stderr.on(\"data\", (data) => {\n\t\t\tffmpegErrors += \"\\n\" + new Buffer(data).toString().trim();\n\t\t});\n\n\t\tenc.stdout.once(\"end\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t});\n\n\t\tenc.stdout.once(\"error\", () => {\n\t\t\tenc.stdout.emit(\"end\");\n\t\t});\n\n\t\tenc.once(\"exit\", (code, signal) => {\n\t\t\tif (code) {\n\t\t\t\treject(new Error(\"FFMPEG: \" + ffmpegErrors));\n\t\t\t}\n\t\t});\n\n\t\tthis.volume.once(\"readable\", () => {\n\t\t\tvar data = {\n\t\t\t\tproc: enc,\n\t\t\t\tstream: this.volume,\n\t\t\t\tchannels: 2\n\t\t\t};\n\n\t\t\tif (stream) {\n\t\t\t\tdata.instream = stream;\n\t\t\t}\n\n\t\t\tresolve(data);\n\t\t});\n\n\t\tthis.volume.once(\"end\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t});\n\n\t\tthis.volume.once(\"error\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t})\n\n\t\tthis.volume.on(\"end\", () => {\n\t\t\tkillProcess(\"end\");\n\t\t});\n\n\t\tthis.volume.on(\"close\", () => {\n\t\t\tkillProcess(\"close\");\n\t\t});\n\t}\n}\n"]}